name: Generate Website

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches:
      - master

jobs:

  generate-website:
    name: Generate Website
    runs-on: ubuntu-latest
    steps:

    - name: Checkout
      uses: actions/checkout@v4

    - uses: actions/setup-node@v4
      with:
        node-version: 18
        cache: npm

    - name: Install dependencies
      run: npm ci
      working-directory: www

    - name: Build website
      run: npm run build -- --out-dir ../_site
      working-directory: www

    - name: Install doxygen and build doxygen doc
      working-directory: ${{github.workspace}}
      run: |
        pip install "sphinx==5.3.0" "pydata-sphinx-theme==0.13.1" sphinx-book-theme exhale
        sudo apt install doxygen
        sphinx-build -M html ./library/doxygen ./library/doxygen/build/
        sudo mv library/doxygen/build/html _site/doc/libf3d/doxygen
        sphinx-build -M html ./vtkext/public/doxygen ./vtkext/public/doxygen/build/
        sudo mv vtkext/public/doxygen/build/html _site/doc/libf3d/vtkext_doxygen

    - name: Deploy
      if: github.ref == 'refs/heads/master'
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        folder: _site
        token: ${{ secrets.GITHUB_TOKEN }}
        clean: true
